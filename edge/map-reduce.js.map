{"version":3,"sources":["map-reduce.js"],"names":["addMapReduce","mapReduce","chain","opts","cb","putCb","opt","bucket","options","fields","allFields","doMapReduce","defaultLogger","fun","logging","args","log","newField","newValue","value","transform","filter","filters","ignoreFields","iterator","validField","processWhile","updateWhen","updateBucket","filterBucket","saveChanges","done","logger","context","ctx","oldProps","newProps","filteredFields","visited","updated","processedFields","field","val","defaultProcessWhile","reVisit","decision","defaultValidField","valid","length","indexOf","invalid","defaultUpdateWhen","processedAll","visitedAll","every","f","defaultSaveChanges","changesObj","put","defaultFilterBucket","deleteKeys","deleteObj","reduce","obj","key","defaultUpdateBucket","props","defaultDone","Error","ensureFun","v","newFieldFun","newValueFun","oldValueFun","map","newKey","newObj","oldValue","doFilter","filtered","doReduce","doUpdate"],"mappings":"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","file":"map-reduce.js","sourcesContent":["import Gun from 'gun/gun'\n\nexport function addMapReduce({\n  chain\n}) {\n  chain.mapReduce = function (opts, cb, putCb, opt) {\n    mapReduce(this, opts, cb, putCb, opt)\n  }\n  return chain\n}\n\nexport function mapReduce(bucket, options = {}, cb, putCb, opt) {\n  bucket.fields((allFields) => {\n    options = Object.assign(options, {\n      allFields\n    })\n    doMapReduce(bucket, options, cb, putCb, opt)\n  })\n}\n\nfunction defaultLogger(fun, logging) {\n  return function (...args) {\n    if (logging)\n      console.log(fun, ...args)\n  }\n}\n\nfunction doMapReduce(bucket, {\n  newField,\n  newValue,\n  value,\n  transform,\n  filter,\n  filters,\n  fields = [],\n  ignoreFields = [],\n  allFields,\n  iterator = 'val',\n  validField,\n  processWhile,\n  updateWhen,\n  updateBucket,\n  filterBucket,\n  saveChanges,\n  done,\n  logging = false,\n  logger,\n  context\n}, cb, putCb, opt) {\n\n  let ctx = {\n    oldProps: {},\n    newProps: {},\n    filteredFields: {},\n    visited: {},\n    updated: false,\n    processedFields: 0,\n    allFields,\n    fields,\n    ignoreFields,\n    iterator,\n    context,\n    putCb,\n    opt\n  }\n\n  transform = transform || function (field, val) {\n    return {}\n  }\n\n  logger = logger || defaultLogger\n\n  const log = logger(iterator, logging)\n\n  log('ctx', ctx)\n\n  function defaultProcessWhile({\n    field,\n    val,\n    ctx\n  }) {\n    let reVisit = ctx.visited[field]\n    let decision = !reVisit\n    log('processWhile', reVisit, decision)\n    return decision\n  }\n\n  function defaultValidField(field, ctx) {\n    let {\n      fields,\n      ignoreFields\n    } = ctx\n    let valid = fields.length === 0 || fields.length > 0 && fields.indexOf(field) >= 0\n    let invalid = ignoreFields.length > 0 && ignoreFields.indexOf(field) >= 0\n    return valid && !invalid\n  }\n\n  function defaultUpdateWhen({\n    field,\n    val,\n    ctx\n  }) {\n    let processedAll = (ctx.processedFields >= ctx.allFields.length)\n    let visitedAll = ctx.allFields.every(f => ctx.visited[f])\n    let decision = visitedAll && processedAll\n    log('updateWhen', visitedAll, processedAll, decision)\n    return decision\n  }\n\n  function defaultSaveChanges(bucket, changesObj, ctx) {\n    bucket.put(changesObj, ctx.putCb, ctx.opt)\n  }\n\n  function defaultFilterBucket(bucket, ctx) {\n    let deleteKeys = Object.keys(ctx.filteredFields)\n    if (deleteKeys.length > 0) {\n      log('FILTER', deleteKeys)\n      let deleteObj = deleteKeys.reduce((obj, key) => {\n        obj[key] = null\n        return obj\n      }, {})\n      log('deleteObj', deleteObj)\n      ctx.saveChanges(bucket, deleteObj, ctx)\n    }\n  }\n\n  function defaultUpdateBucket(bucket, ctx) {\n    log('UPDATE', props)\n    let props = Object.assign(ctx.oldProps, ctx.newProps)\n    ctx.saveChanges(bucket, props, ctx)\n  }\n\n  function defaultDone(bucket, cb, ctx) {\n    log('DONE')\n    if (cb) {\n      cb(bucket, ctx)\n    } else {\n      throw Error(`${ctx.iterator}: missing callback (in done)`)\n    }\n  }\n\n  validField = validField || defaultValidField\n  processWhile = processWhile || defaultProcessWhile\n  updateWhen = updateWhen || defaultUpdateWhen\n  updateBucket = updateBucket || defaultUpdateBucket\n  filterBucket = filterBucket || defaultFilterBucket\n  saveChanges = saveChanges || defaultSaveChanges\n  done = done || defaultDone\n\n  ctx.saveChanges = saveChanges\n\n  function ensureFun(fun) {\n    if (fun && typeof fun !== 'function') {\n      return (v) => fun\n    } else {\n      return fun\n    }\n  }\n\n  let newFieldFun = ensureFun(newField)\n  let newValueFun = ensureFun(newValue)\n  let oldValueFun = ensureFun(value)\n\n  log(allFields)\n\n  // processWhile = processWhile.bind(this)\n  // updateWhen = updateWhen.bind(this)\n\n  bucket.map()[iterator](function (val, field) {\n    log('iterate', {\n      field,\n      val\n    })\n    if (!validField(field, ctx)) return\n\n    let newKey = newFieldFun ? newFieldFun(field, val, ctx) : field\n    let newValue = newValueFun ? newValueFun(val, field, ctx) : val\n    let newObj = transform(field, val, ctx)\n\n    let oldValue = oldValueFun ? oldValueFun(val, field, ctx) : val\n    let doFilter = false\n\n    if (filters) {\n      log('process filters', filters.length)\n      doFilter = filters.reduce((filtered, filter) => {\n        return !filtered ? filter(field, val, ctx) : filtered\n      }, false)\n    }\n\n    if (filter && filter(field, val)) {\n      doFilter = true\n    }\n\n    log({\n      newKey,\n      newValue,\n      oldValue,\n      doFilter\n    })\n\n    let doReduce = processWhile({\n      field,\n      val,\n      ctx\n    })\n    log('doReduce', doReduce)\n\n    if (doReduce) {\n      log('reduce', {\n        field,\n        val,\n        processedFields: ctx.processedFields\n      })\n      if (doFilter) {\n        ctx.filteredFields[field] = true\n      } else {\n        ctx.newProps = Object.assign(ctx.newProps, newObj)\n        ctx.newProps[newKey] = newValue\n\n        ctx.oldProps[field] = oldValue\n      }\n      ctx.visited[field] = true\n      ctx.visited[newKey] = true\n      ctx.processedFields++\n    }\n    let doUpdate = updateWhen({\n      field,\n      val,\n      ctx\n    })\n    log('doUpdate', doUpdate, ctx.processedFields)\n    if (doUpdate) {\n      if (!ctx.updated) {\n        log('UPDATE BUCKET')\n        ctx.updated = true\n        updateBucket(bucket, ctx)\n        filterBucket(bucket, ctx)\n        done(bucket, cb, ctx)\n      } else {\n        log('ignore update')\n      }\n    }\n  })\n}"]}